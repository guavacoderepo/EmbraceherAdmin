<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses | EmbraceHer</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="../styles/modal.css">
    <link rel="stylesheet" href="../styles/authentication.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
    <link rel="shortcut icon" href="../assets/embrace.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Montez&family=Poppins&family=Tilt+Prism&display=swap" rel="stylesheet">
</head>
<body>
    <nav>
        <h3><a href="./dashboard.html">EmbraceHer</a></h3>
        <div class="admin">
            <div id="adminIcon">
                <a href="./profile.html">
                    <img src="../assets/user.png" alt="admin icon" id="adminImg">
                </a>
            </div>
            <div class="admin-title">
                <p id="ad-name">Loading level...</p>
                <p id="ad-email">loading email...</p>
            </div>
        </div>
    </nav>
    <aside>
        <ul>
            <li><i class="fas fa-tachometer-alt"></i><a href="./dashboard.html">Dashboard</a></li>
            <li><i class="fas fa-user"></i><a href="./users.html">Users</a></li>
            <li style="font-weight: bolder"><i class="fas fa-cart-plus"></i><a href="./courses.html">Courses</a></li>
            <li><i class="fas fa-notes-medical"></i><a href="./health-tips.html">Health Tips</a></li>
            <li><i class="fas fa-thumbs-up"></i><a href="./recommendation.html">Recommendation</a></li>
            <li><i class="fas fa-dumbbell"></i><a href="./weight-loss.html">Weight Loss</a></li>
        </ul>
        <button type="button" id="admin-btn" title="add admin">Add an admin</button>
        <button type="button" id="log-out" title="log out">Logout</button>
    </aside>
    <section class="main" id="mainnest">
        <div class="course-head">
            <h2>Courses</h2>
            <div class="filter-options">
                <button id="all">All</button>
                <button id="beginners">Beginners</button>
                <button id="intermediate">Intermediate</button>
                <button id="expert">Expert</button>
                <input type="search" name="" id="search" placeholder="search by title...">
            </div>
        </div>
        <div id="modal">
            <div id="modal-content">
                <span id="close-button" style="display: none;">×</span>
                <form id="admin-form">
                    <h1>ADD ADMIN <br><span>Fill in the admin details.</span></h1>
                    <section class="inputBox">
                        <input type="email" name="" id="admin-email" required>
                        <span>Email address</span>
                    </section>
                    <section class="inputBox">
                        <input type="number" min='1' max='10' name="" min="1" max="10" id="admin-level" required>
                        <span>Admin level <b style="color: red; font-size: 10px;">(btw 1 and 10)</b></span>
                    </section>
                    <section class="inputBox">
                        <input type="password" name="" id="admin-pwd" required>
                        <span>Password</span>
                    </section>
                    <div>
                        <button type="submit" id="signup">SIGNUP</button>
                    </div>
                </form>
            </div>
        </div>
        <main>
            <div class="modal" id="curse">
                <div class="modal-content" id="cursor">
                    <form id="update-form">
                        <span class="close-button">×</span>
                        <label for="table-title">Title</label><br>
                        <input type="text" id="table-title" required><br><br>
                        <label for="table-category">Category</label><br>
                        <select id="table-category" required>
                            <option value="">Select category:</option>
                            <option value="beginners">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="expert">Expert</option>
                        </select><br><br>
                        <label for="table-subcategory">SubCategory</label><br>
                        <select id="table-subcategory" required>
                            <option value="">Select sub-category:</option>
                            <option value="ab">Ab</option>
                            <option value="butt">Butt</option>
                            <option value="leg">Leg</option>
                            <option value="full">Full</option>
                            <option value="arm">Arm</option>
                            <option value="cardio">Cardio</option>
                        </select><br><br>
                        <label for="table-description">Description</label><br>
                        <textarea id="table-description" cols="55" rows="6" required></textarea><br><br>
                        <label for="table-image-src">ImageUrl</label><br>
                        <input type="text" id="table-image-src" required><br><br>
                        <input type="hidden" name="" id="table-course-id">
                        <button type="submit" id="update" style="cursor: pointer;">Update</button>
                    </form>
                </div>
            </div>
            <div class="modal2" id="curse2">
                <div class="modal-content2" id="cursor2">
                    <form id="update-form2">
                        <span class="close-button2">×</span>
                        <label for="table-title2">Title</label><br>
                        <input type="text" id="table-title2" required><br><br>
                        <label for="table-category2">Category</label><br>
                        <select id="table-category2" required>
                            <option value="">Select category:</option>
                            <option value="beginners">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="expert">Expert</option>
                        </select><br><br>
                        <label for="table-subcategory2">SubCategory</label><br>
                        <select id="table-subcategory2" required>
                            <option value="">Select sub-category:</option>
                            <option value="ab">Ab</option>
                            <option value="butt">Butt</option>
                            <option value="leg">Leg</option>
                            <option value="full">Full</option>
                            <option value="arm">Arm</option>
                            <option value="cardio">Cardio</option>
                        </select><br><br>
                        <label for="table-description2">Description</label><br>
                        <textarea id="table-description2" cols="55" rows="6" required></textarea><br><br>
                        <label for="table-image-src2">ImageUrl</label><br>
                        <input type="text" id="table-image-src2" required><br><br>
                        <input type="hidden" name="" id="table-course-id2">
                        <button type="submit" id="update2" style="cursor: pointer;">Add Course</button>
                    </form>
                </div>
            </div>
            <table id="user-table" class="re-commend course">
                <tr>
                    <th>Image</th>
                    <th>Title</th>
                    <th>Category</th>
                    <th>SubCategory</th>
                    <th>Description</th>
                    <th>Action</th>
                </tr>
                <div id="loading" style="display: none;">Loading...</div
            </table>
        </main>
    </section>

    <span id="add" title="Upload document">+</span>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
        // Get the token from localStorage
        const token = sessionStorage.getItem('token');

        console.log("Token from sessionStorage:", token);

        if (token) {
            const apiUrl = "https://embraceher.onrender.com";
            const endpoint = "/api/v1/admin/me";
            const url = apiUrl + endpoint;

            fetch(url, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Request failed with status: ${response.status}`);
                }
                return response.json();
            })
            .then(user => {
                console.log("User Data:", user);
                const adName = document.getElementById('ad-name');
                const adEmail = document.getElementById('ad-email');

                adName.innerHTML = 'Admin' + ' ' + '<b>' + 'Level' + ' ' + user.data.level + '</b>';
                adEmail.innerHTML = user.data.email;
                adEmail.style.fontSize = '12px';
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }
    });
    </script>

    <!-- Update course -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        // ...

        // Function to update the weight loss record
        function updateWeightLossRecord(event) {
            event.preventDefault();

            const token = sessionStorage.getItem('token');
            // Get the weight loss record ID from the hidden input field
            const weightId = document.getElementById("table-course-id").value;

            if (token) {
            // Construct the API endpoint for updating the weight loss record
            const apiUrl = `https://embraceher.onrender.com`;
            const updateEndpoint = `/api/v1/course/${weightId}`;

            // Get the updated data from the form fields
            const updatedImg = document.getElementById("table-image-src").value;
            const updatedName = document.getElementById("table-title").value;
            const updatedCategory = document.getElementById("table-category").value;
            const updatedSubCategory = document.getElementById("table-subcategory").value;
            const updatedDescription = document.getElementById("table-description").value;

            // Create a payload with the updated data
            const payload = {
                imgUrl: updatedImg,
                name: updatedName,
                category: updatedCategory,
                subCategory: updatedSubCategory,
                description: updatedDescription,
            };

            // Make a PUT request to update the weight loss record
            fetch(apiUrl + updateEndpoint, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json", // Specify JSON content type
                },
                body: JSON.stringify(payload), // Convert payload to JSON
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Request failed with status: ${response.status}`);
                }
                return response.json();
            })
            .then(updatedRecord => {
                alert('Course record has been successfully updated');
                console.log("Course record updated", updatedRecord);
                const modal = document.querySelector(".modal");
                modal.style.display = "none"; // Close the modal after updating
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }
        }
        // Add an event listener to the "Update" button in the modal
        const updateButton = document.getElementById("update");
        updateButton.addEventListener("click", updateWeightLossRecord);

    });
    </script>

    <!-- Fetch courses -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
        // Get the token from localStorage
        const token = sessionStorage.getItem('token');

        console.log("Token from sessionStorage:", token);

        if (token) {
            const apiUrl = "https://embraceher.onrender.com";
            const endpoint = "/api/v1/course";
            const url = apiUrl + endpoint;

            // Show loading component while fetching
            const loadingComponent = document.getElementById('loading');
            loadingComponent.style.display = 'block';
            document.getElementById('mainnest').style.borderLeft = 'none'

            fetch(url, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Request failed with status: ${response.status}`);
                }
                return response.json();
            })
            .then(allcourses => {
                console.log("All Courses:", allcourses);
                const table = document.getElementById('user-table');

                // Hide loading component after fetching
                loadingComponent.style.display = 'none';
                // document.getElementById('mainnest').style.borderLeft = '1px solid #13a7e7'


                allcourses.data.forEach(course => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-course-id', course._id);
                    row.innerHTML = `
                        <td>${course.imgUrl}</td>
                        <td>${course.name}</td>
                        <td>${course.category}</td>
                        <td>${course.subCategory}</td>
                        <td>${course.description}</td>
                        <td>
                            <i class="fas fa-pen" title="Edit"></i>
                            <i class="fas fa-trash" title="Delete"></i>
                        </td>
                    `;
                    table.appendChild(row);

                    // Select the modal and its input fields
                    const modal = document.querySelector(".modal");
                    
                    // Function to open the modal and populate the fields
                    function openModal(event) {
                        modal.style.display = "block";
                        const modalContent = document.querySelector(".modal-content");

                        const tableRow = event.target.closest("tr");
                        const tds = tableRow.querySelectorAll("td");

                        const title = tds[1].textContent;

                        // Find the matching user for the clicked row
                        const clickedReco = allcourses.data.find(u => u.name === title);

                        if (clickedReco) {
                            modalContent.querySelector("#table-course-id").value = clickedReco._id;
                            modalContent.querySelector("#table-title").value = clickedReco.name;
                            modalContent.querySelector("#table-category").value = clickedReco.category;
                            modalContent.querySelector("#table-subcategory").value = clickedReco.subCategory;
                            modalContent.querySelector("#table-description").value = clickedReco.description;
                            modalContent.querySelector("#table-image-src").value = clickedReco.imgUrl;
                        }
                        console.log(clickedReco.category);
                    }

                    // Select the close button in the modal
                    const closeButton = document.querySelector(".close-button");

                    // Function to close the modal
                    function closeModal() {
                        modal.style.display = "none";
                    }

                    // Add click event listener to close button
                    closeButton.addEventListener("click", closeModal);

                    // Add event listeners to the pen icons for opening the modal
                    const penIcons = document.querySelectorAll(".fas.fa-pen");
                    penIcons.forEach((icon) => {
                        icon.addEventListener("click", openModal);
                    });

                    // Get all trash icons with the specific class
                    const trashIcons = document.querySelectorAll(".fas.fa-trash");

                    trashIcons.forEach((icon) => {
                        if (!icon.classList.contains('delete-button-listener-added')) {
                            icon.addEventListener("click", deleteRow);
                            icon.classList.add('delete-button-listener-added');
                        }
                    });


                    // Function to delete the row with a confirmation prompt
                    function deleteRow(event) {
                        event.preventDefault(); 

                        const trashIcon = event.target;
                        const tableRow = trashIcon.closest("tr");

                        const courseId = tableRow.getAttribute('data-course-id');

                        const confirmation = confirm("Are you sure you want to delete this course?");
                        
                        if (confirmation) {
                            console.log("Deleted Course ID:", courseId);
                            if (token) {
                                const apiUrl = `https://embraceher.onrender.com`;
                                const endpoint = `/api/v1/course/${courseId}`;
                                const url = apiUrl + endpoint;

                                fetch(url, {
                                    method: "DELETE",
                                    headers: {
                                        "Authorization": `Bearer ${token}`
                                    }
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`Request failed with status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(user => {
                                    alert('Course has been successfully deleted');
                                    console.log("Course deleted");
                                })
                                .catch(error => {
                                    console.error("Error:", error);
                                });
                            }
                            tableRow.remove();
                        }
                    }
                });
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }
    });  
    </script>

    <script>
// Add Course
document.addEventListener("DOMContentLoaded", function () {
    // Function to update the weight loss record
    function addCourse(event) {
        event.preventDefault();

        const token = sessionStorage.getItem('token');

        if (token) {
        // Construct the API endpoint for updating the weight loss record
        const apiUrl = `https://embraceher.onrender.com`;
        const updateEndpoint = `/api/v1/course/`;

        // Get the updated data from the form fields
        const addName = document.getElementById("table-title2").value;
        const addCategory = document.getElementById("table-category2").value;
        const addSubCategory = document.getElementById("table-subcategory2").value;
        const addDescription = document.getElementById("table-description2").value;
        const addImg = document.getElementById("table-image-src2").value;

        // Create a payload with the added data
        const payload = {
          name: addName,
          category: addCategory,
          subCategory: addSubCategory,
          description: addDescription,
          imgUrl: addImg,
        };

        // Make a POST request to add course
        fetch(apiUrl + updateEndpoint, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json", // Specify JSON content type
            },
            body: JSON.stringify(payload), // Convert payload to JSON
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Request failed with status: ${response.status}`);
            }
            return response.json();
        })
        .then(addRecord => {
            alert('Course record has been successfully added');
            console.log("Course record added", addRecord);
            const modal2 = document.querySelector(".modal2");
            modal2.style.display = "none"; 
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }
    }
    // Add an event listener to the "Add course" button in the modal
    const addButton = document.getElementById("update2");
    addButton.addEventListener("click", addCourse);

});
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        function handleLogout () {
            const shouldLogout = window.confirm("Are you sure you want to log out?");
            if (shouldLogout) {
                sessionStorage.removeItem('token');
                window.history.replaceState(null, '', './index.html')
                window.location.href = './index.html'
            }
        }
        const logout = document.getElementById('log-out');
        logout.addEventListener('click', handleLogout);
    })
    </script>
    
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script> 
    <script src="../scripts/filter.js"></script>
    <script src="../scripts/upload.js"></script>
    <script src="../scripts/modal.js"></script>
</body>
</html>